<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="baidu-site-verification" content="093lY4ziMu" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="A hexo theme">
    <meta name="keyword"  content="saltyfishyjk, yjk, @saltyfishyjk, @yjk, saltyfishyjk&#39;s Blog">
    <link rel="shortcut icon" href="/img/x.ico">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!--<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>-->
    <title>
        
          「BUAA OS Lab3」名词解释 - saltyfishyjk
        
    </title>

    <link rel="canonical" href="https://saltyfishyjk.github.io/2022/04/26/「BUAA-OS-Lab3」名词解释/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
        
<link rel="stylesheet" href="/css/dusign-light.css">

        
<link rel="stylesheet" href="/css/dusign-common-light.css">

        
<link rel="stylesheet" href="/css/font-awesome.css">

        
<link rel="stylesheet" href="/css/toc.css">

        <!-- background effects end -->
    
    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/fonts.googleapis.css">


    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- photography -->
    
<link rel="stylesheet" href="/css/photography.css">


    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="saltyfishyjk's Blog" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- background effects start -->
    
    <!-- background effects end -->

	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            
                background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('../../../../img/default.jpg')
                /*post*/
            
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#BUAA-OS" title="BUAA-OS">BUAA-OS</a>
                            
                        </div>
                        <h1>「BUAA OS Lab3」名词解释</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by saltyfishyjk on
                            2022-04-26
                        </span>

                        
                            <div class="blank_box"></div>
                            <span class="meta">
                                Words <span class="post-count">3.8k</span> and
                                Reading Time <span class="post-count">19</span> Minutes
                            </span>
                            <div class="blank_box"></div>
                            <!-- 不蒜子统计 start -->
                            <span class="meta">
                                Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
                            </span>
                            <!-- 不蒜子统计 end -->
                        

                    </div>
                

                </div>
            </div>
        </div>      
    </div>

    
    <div class="waveWrapper">
        <div class="wave wave_before" style="background-image: url('/img/wave-light.png')"></div>
        <div class="wave wave_after" style="background-image: url('/img/wave-light.png')"></div>
    </div>
    
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">saltyfishyjk&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                    
                    <li>
                        <a href="https://home.cnblogs.com/u/saltyfishyjk" target="_blank">Chinese Blog</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="「BUAA-OS-Lab3」名词解释"><a href="#「BUAA-OS-Lab3」名词解释" class="headerlink" title="「BUAA OS Lab3」名词解释"></a>「BUAA OS Lab3」名词解释</h1><h2 id="变量和类型"><a href="#变量和类型" class="headerlink" title="变量和类型"></a>变量和类型</h2><h3 id="PCB"><a href="#PCB" class="headerlink" title="PCB"></a><code>PCB</code></h3><p>进程控制块（Process Conotrol Block），系统感知进程存在的唯一标志。进程和PCB一一对应。</p>
<hr>
<h3 id="Env"><a href="#Env" class="headerlink" title="Env"></a><code>Env</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> <span class="title">env_tf</span>;</span> <span class="comment">// Saved registers </span></span><br><span class="line">	LIST_ENTRY(Env) env_link; <span class="comment">// Free LIST_ENTRY</span></span><br><span class="line">	u_int env_id;                  <span class="comment">// Unique environment identifier </span></span><br><span class="line">	u_int env_parent_id;           <span class="comment">// env_id of this env&#x27;s parent </span></span><br><span class="line">	u_int env_status;              <span class="comment">// Status of the environment</span></span><br><span class="line">	Pde  *env_pgdir;               <span class="comment">// Kernel virtual address of page dir </span></span><br><span class="line">	u_int env_cr3;</span><br><span class="line">	LIST_ENTRY(Env) env_sched_link; </span><br><span class="line">	u_int env_pri;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Env-list"><a href="#Env-list" class="headerlink" title="Env_list"></a><code>Env_list</code></h3><p>位置：<code>env.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIST_HEAD(Env_list, Env);</span><br></pre></td></tr></table></figure>

<p>工厂模式构造<code>Env_list</code>类型，内部含有一个<code>struct type *lh_first</code>的变量，相当于构造了头结点类型<code>Env_list</code>。</p>
<hr>
<h3 id="env-tf"><a href="#env-tf" class="headerlink" title="env_tf"></a><code>env_tf</code></h3><p>env trapframe</p>
<p><code>Trapframe</code>结构体的定义在<code>include/trap.h</code>中，在发生进程调度或陷入内核中时，会将当时的进程上下文环境保存在<code>env_tf</code>变量中。</p>
<p><code>Trapframe</code>结构体内容见下。</p>
<hr>
<h3 id="Trapframe"><a href="#Trapframe" class="headerlink" title="Trapframe"></a><code>Trapframe</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> &#123;</span> <span class="comment">//lr:need to be modified(reference to linux pt_regs) TODO</span></span><br><span class="line">	<span class="comment">/* Saved main processor registers. */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> regs[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Saved special registers. */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cp0_status;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> hi;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> lo;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cp0_badvaddr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cp0_cause;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cp0_epc;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> pc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="env-link"><a href="#env-link" class="headerlink" title="env_link"></a><code>env_link</code></h3><p><code>env_link</code>的机制类似lab2的<code>pp_link</code>，使用<code>env_link</code>和<code>env_free_list</code>来构造空闲进程链表。</p>
<hr>
<h3 id="env-id"><a href="#env-id" class="headerlink" title="env_id"></a><code>env_id</code></h3><p>每个进程都有区别于其他进行的标识符<code>env_id</code></p>
<hr>
<h3 id="env-parent-id"><a href="#env-parent-id" class="headerlink" title="env_parent_id"></a><code>env_parent_id</code></h3><p>创建本进程的进程称为父进程，<code>env_parent_id</code>记录父进程的进程<code>id</code>，借此可以使进程构成进程树。</p>
<hr>
<h3 id="env-status"><a href="#env-status" class="headerlink" title="env_status"></a><code>env_status</code></h3><p>该变量只可能取以下三个值之一：</p>
<ul>
<li><code>ENV_FREE</code>：表明该进程不活动，即，其处于进程空闲链表中</li>
<li><code>ENV_NOT_RUNNABLE</code>：表明该进程处于<strong>阻塞状态</strong>，需要经过一定条件转为<strong>就绪状态</strong>，从而才可以被CPU调度</li>
<li><code>ENV_RUNNABLE</code>：表明该进程处于<strong>执行状态或就绪状态</strong>，即，可能是正在运行的，也可能在等待调度</li>
</ul>
<hr>
<h3 id="env-pgdir"><a href="#env-pgdir" class="headerlink" title="env_pgdir"></a><code>env_pgdir</code></h3><p>env page directory</p>
<p>保存<strong>该进程页目录</strong>的<strong>内核虚拟地址</strong>。</p>
<hr>
<h3 id="env-cr3"><a href="#env-cr3" class="headerlink" title="env_cr3"></a><code>env_cr3</code></h3><p>env </p>
<p>保存该进程页目录的物理地址。</p>
<hr>
<h3 id="env-sched-link"><a href="#env-sched-link" class="headerlink" title="env_sched_link"></a><code>env_sched_link</code></h3><p>env scheduled link</p>
<p>进程调度队列的链表项。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIST_ENTRY(Env) env_sched_link;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="env-pri"><a href="#env-pri" class="headerlink" title="env_pri"></a><code>env_pri</code></h3><p>env priority</p>
<p>保存该进程的优先级。</p>
<hr>
<h3 id="env-runs"><a href="#env-runs" class="headerlink" title="env_runs"></a><code>env_runs</code></h3><p>number of times have been runned</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u_int env_runs;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="LOG2NENV"><a href="#LOG2NENV" class="headerlink" title="LOG2NENV"></a><code>LOG2NENV</code></h3><p>$ log_{2}{NENV} $</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LOG2NENV  10</span></span><br></pre></td></tr></table></figure>

<p>一共1024个<code>env</code>，因此是<code>10</code>位</p>
<hr>
<h3 id="UTOP与ULIM"><a href="#UTOP与ULIM" class="headerlink" title="UTOP与ULIM"></a><code>UTOP</code>与<code>ULIM</code></h3><p><code>UTOP</code>之下是用户进程可以自由读写的地址区域，<code>ULIM</code>是用户进程的最高地址，在<code>UTOP</code>到<code>ULIM</code>的区域与其他用户区相比最大的区别是用户只能读，不能写。</p>
<hr>
<h3 id="cp0-status"><a href="#cp0-status" class="headerlink" title="cp0_status"></a><code>cp0_status</code></h3><p><code>cp0_status</code>就是MIPS R3000中的SR(Status Register)寄存器</p>
<hr>
<h3 id="KUo-IEo-KUp-IEp-KUc-IEc-rfe"><a href="#KUo-IEo-KUp-IEp-KUc-IEc-rfe" class="headerlink" title="KUo &amp; IEo // KUp &amp; IEp // KUc &amp; IEc || rfe"></a><code>KUo &amp; IEo // KUp &amp; IEp // KUc &amp; IEc || rfe</code></h3>



<p>KU(Kernel&#x2F;User)表示是否位于内核模式下，为1表示位于内核模式下</p>
<p>IE(Interrupt Enable)表示中断是否开启，为1表示开启，否则不开启</p>
<p><code>KUo &amp; IEo</code>：<code>o</code>表示old</p>
<p><code>KUp &amp; IEp</code>：<code>p</code>表示previous</p>
<p><code>KUc &amp; IEc</code>：<code>c</code>表示current</p>
<p>这低6位结构式二重栈，共三组。当中断发生时，硬件会自动将<code>KUp</code>和<code>IEp</code>的内容拷贝到<code>KUo</code>和<code>IEo</code>；将<code>KUc</code>和<code>IEc</code>拷贝到<code>KUp</code>和<code>IEp</code>中。</p>
<p>而<code>rfe</code>(Return From Exception)指令是上述操作的逆操作，guidebook中介绍如下代码是每个进程每一次被调度的时候都会执行的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lw k0, TF_STATUS(k0) # 恢复CP0_STATUS寄存器</span><br><span class="line">mtc0 k0, CP0_STATUS</span><br><span class="line">j k1</span><br><span class="line">rfe</span><br></pre></td></tr></table></figure>

<p>这样可以解释设置<code>status</code>后6位为0的原因：运行进程前，上述代码会运行到<code>rfe</code>，将<code>KUp</code>和<code>IEp</code>拷贝回到<code>KUc</code>和<code>IEc</code>，这时<code>status</code>变成了 $ 000001 $ ，最后两位<code>KUc</code>和<code>IEc</code>为 $ [0, 1] $ ，表示开启了中断。这之后，第一个进程成功运行，我们的操作系统就可以在正常响应中断了。</p>
<hr>
<h3 id="TIMESTACK"><a href="#TIMESTACK" class="headerlink" title="TIMESTACK"></a><code>TIMESTACK</code></h3><p>时钟栈，存储时钟中断的时候的trapframe。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TIMESTACK 0x82000000</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="exception-handlers"><a href="#exception-handlers" class="headerlink" title="exception_handlers"></a><code>exception_handlers</code></h3><p>位置：<code>lib/traps.c</code></p>
<p>异常向量组，在<code>.text.exc.vec3</code>这一异常分发代码结束时会按照<code>exception_handlers</code>这一数组基地址加上<code>Cause</code>寄存器中2-6位得到的<code>ExcCode</code>偏移得到正确的异常处理函数地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> exception_handlers[<span class="number">32</span>];</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="函数和宏函数"><a href="#函数和宏函数" class="headerlink" title="函数和宏函数"></a>函数和宏函数</h2><h3 id="env-init"><a href="#env-init" class="headerlink" title="env_init()"></a><code>env_init()</code></h3><p>初始化<code>ene_free_list</code></p>
<hr>
<h3 id="mkenvid"><a href="#mkenvid" class="headerlink" title="mkenvid"></a><code>mkenvid</code></h3><p>返回值：<code>u_int</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">u_int <span class="title function_">mkenvid</span><span class="params">(<span class="keyword">struct</span> Env *e)</span> &#123;</span><br><span class="line">    u_int idx = e - envs;</span><br><span class="line">    u_int asid = asid_alloc();</span><br><span class="line">    <span class="keyword">return</span> (asid &lt;&lt; (<span class="number">1</span> + LOG2NENV)) | (<span class="number">1</span> &lt;&lt; LOG2NENV) | idx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成一个新的进程标识符。</p>
<p>低10位是idx，即env在envs数组中的索引；第10位是1，为了防止envid为0；11-16位是asid</p>
<hr>
<h3 id="asid-alloc"><a href="#asid-alloc" class="headerlink" title="asid_alloc()"></a><code>asid_alloc()</code></h3><p>申请一个<code>asid</code>。</p>
<p>使用位图法管理asid。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> u_int asid_bitmap[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// 位图法管理64个asid</span></span><br><span class="line"><span class="type">static</span> u_int <span class="title function_">asid_alloc</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i, index, inner;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i) &#123;</span><br><span class="line">        index = i &gt;&gt; <span class="number">5</span>; <span class="comment">// index标记索引，即具体是哪个asid_bitmap</span></span><br><span class="line">        inner = i &amp; <span class="number">31</span>; <span class="comment">// i&amp;31，即获取低5位，舍弃第6位</span></span><br><span class="line">        <span class="keyword">if</span> ((asid_bitmap[index] &amp; (<span class="number">1</span> &lt;&lt; inner)) == <span class="number">0</span>) &#123; <span class="comment">// 将管理i对应的位取出，判断是否为0，若为0则说明该asid可以申请。</span></span><br><span class="line">            asid_bitmap[index] |= <span class="number">1</span> &lt;&lt; inner; <span class="comment">// 将对应的位置1，标记这个asid已经被申请</span></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    panic(<span class="string">&quot;too many processes!&quot;</span>); <span class="comment">// 若最后也没有找到可以用的asid，返回报错信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="envid2env"><a href="#envid2env" class="headerlink" title="envid2env"></a><code>envid2env</code></h3><p><code>envid2env(u_int envid, struct Env **penv, int checkperm)</code></p>
<p>根据<code>envid</code>找到对应的<code>env</code></p>
<hr>
<h3 id="env-alloc"><a href="#env-alloc" class="headerlink" title="env_alloc"></a><code>env_alloc</code></h3><p>返回值：<code>int</code></p>
<hr>
<h3 id="env-setup-vm"><a href="#env-setup-vm" class="headerlink" title="env_setup_vm"></a><code>env_setup_vm</code></h3><p><code>env_setup_vm(struct Env *e)</code></p>
<hr>
<h3 id="env-create"><a href="#env-create" class="headerlink" title="env_create"></a><code>env_create</code></h3><p>返回值：<code>void</code></p>
<p>创建进程。以默认优先级申请一个<code>env</code>，实际上是调用<code>env_create_priority</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_create</span><span class="params">(u_char *binary, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="comment">/* Step 1: Use env_create_priority to alloc a new env with priority 1 */</span></span><br><span class="line">	env_create_priority(binary, size, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="env-create-priority"><a href="#env-create-priority" class="headerlink" title="env_create_priority"></a><code>env_create_priority</code></h3><p>返回值：<code>void</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_create_priority</span><span class="params">(u_char *binary, <span class="type">int</span> size, <span class="type">int</span> priority)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="comment">/* Step 1: Use env_alloc to alloc a new env. */</span></span><br><span class="line">	<span class="keyword">if</span> (env_alloc(&amp;e, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/* Step 2: assign priority to the new env. */</span></span><br><span class="line">	e-&gt;env_pri = priority;</span><br><span class="line">    <span class="comment">/* Step 3: Use load_icode() to load the named elf binary,</span></span><br><span class="line"><span class="comment">       and insert it into env_sched_list using LIST_INSERT_HEAD. */</span></span><br><span class="line">	load_icode(e, binary, size);</span><br><span class="line">	LIST_INSERT_HEAD(&amp;env_sched_list[<span class="number">0</span>], e, env_sched_link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ENV-CREATE"><a href="#ENV-CREATE" class="headerlink" title="ENV_CREATE"></a><code>ENV_CREATE</code></h3><p>将<code>env_create</code>封装起来的宏函数，作用是根据给定参数调用<code>env_create</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ENV_CREATE(x) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">    extern u_char binary_##x##_start[];\</span></span><br><span class="line"><span class="meta">    extern u_int binary_##x##_size; \</span></span><br><span class="line"><span class="meta">    env_create(binary_##x##_start, \</span></span><br><span class="line"><span class="meta">        (u_int)binary_##x##_size); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>##</code>是拼接符号，在lab3中我们在<code>init.c</code>中以<code>user_A</code>和<code>user_B</code>为参数分别启动两个进程，可以在<code>/init/code_a.c</code>和<code>/init/code_b.c</code>中查看进程的具体配置</p>
<hr>
<h3 id="ENV-CREATE-PRIORITY"><a href="#ENV-CREATE-PRIORITY" class="headerlink" title="ENV_CREATE_PRIORITY"></a><code>ENV_CREATE_PRIORITY</code></h3><p>将<code>env_create_priority</code>封装起来的宏函数，作用是根据给定参数调用<code>env_create_priority</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ENV_CREATE_PRIORITY(x, y) \</span></span><br><span class="line"><span class="meta">&#123;\</span></span><br><span class="line"><span class="meta">        extern u_char binary_##x##_start[]; \</span></span><br><span class="line"><span class="meta">        extern u_int binary_##x##_size;\</span></span><br><span class="line"><span class="meta">        env_create_priority(binary_##x##_start, \</span></span><br><span class="line"><span class="meta">                (u_int)binary_##x##_size, y);\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="load-icode"><a href="#load-icode" class="headerlink" title="load_icode"></a><code>load_icode</code></h3><p>返回值：<code>void</code></p>
<p>特殊类型：<code>static</code></p>
<p>load image code 加载镜像代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">load_icode</span><span class="params">(<span class="keyword">struct</span> Env *e, u_char *binary, u_int size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Hint:</span></span><br><span class="line"><span class="comment">     *  You must figure out which permissions you&#x27;ll need</span></span><br><span class="line"><span class="comment">     *  for the different mappings you create.</span></span><br><span class="line"><span class="comment">     *  Remember that the binary image is an a.out format image,</span></span><br><span class="line"><span class="comment">     *  which contains both text and data.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    u_long entry_point;</span><br><span class="line">    u_long r;</span><br><span class="line">    u_long perm;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 1: alloc a page. */</span></span><br><span class="line">	perm = PTE_R;</span><br><span class="line">	<span class="keyword">if</span> ((r = page_alloc(&amp;p)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/* Step 2: Use appropriate perm to set initial stack for new Env. */</span></span><br><span class="line">    <span class="comment">/* Hint: Should the user-stack be writable? */</span></span><br><span class="line">	<span class="keyword">if</span> ((r = page_insert(e-&gt;env_pgdir, p, USTACKTOP - BY2PG, perm)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((r = load_elf(binary, size, &amp;entry_point, e, load_icode_mapper)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 3: load the binary using elf loader. */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 4: Set CPU&#x27;s PC register as appropriate value. */</span></span><br><span class="line">    e-&gt;env_tf.pc = entry_point;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="load-icode-mapper"><a href="#load-icode-mapper" class="headerlink" title="load_icode_mapper"></a><code>load_icode_mapper</code></h3><p>返回值：<code>int</code></p>
<p>特殊类型：<code>static</code></p>
<p><code>static int load_icode_mapper(u_long va, u_int32_t sgsize,u_char *bin, u_int32_t bin_size, void *user_data)</code></p>
<p>位置：<code>lib/env.c</code></p>
<p>load image code mapper 加载镜像映射</p>
<hr>
<h3 id="is-elf-format"><a href="#is-elf-format" class="headerlink" title="is_elf_format"></a><code>is_elf_format</code></h3><p>返回值：<code>int</code>，当判定符合elf格式时返回1，否则返回0</p>
<p>位置：<code>lib/kernel_elfloader.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">is_elf_format</span><span class="params">(u_char *binary)</span> &#123;</span><br><span class="line">    Elf32_Ehdr *ehdr = (Elf32_Ehdr *) binary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ehdr-&gt;e_ident[<span class="number">0</span>] == EI_MAG0 &amp;&amp;</span><br><span class="line">        ehdr-&gt;e_ident[<span class="number">1</span>] == EI_MAG1 &amp;&amp;</span><br><span class="line">        ehdr-&gt;e_ident[<span class="number">2</span>] == EI_MAG2 &amp;&amp;</span><br><span class="line">        ehdr-&gt;e_ident[<span class="number">3</span>] == EI_MAG3) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="load-elf"><a href="#load-elf" class="headerlink" title="load_elf"></a><code>load_elf</code></h3><p>返回值：<code>int</code></p>
<p>位置：<code>lib/kernenl_elfloader.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">load_elf</span><span class="params">(u_char *binary, <span class="type">int</span> size, u_long *entry_point, <span class="type">void</span> *user_data,</span></span><br><span class="line"><span class="params">			 <span class="type">int</span> (*<span class="built_in">map</span>)(u_long va, <span class="type">u_int32_t</span> sgsize,</span></span><br><span class="line"><span class="params">						u_char *bin, <span class="type">u_int32_t</span> bin_size, <span class="type">void</span> *user_data))</span></span><br><span class="line">&#123;</span><br><span class="line">	Elf32_Ehdr *ehdr = (Elf32_Ehdr *)binary;</span><br><span class="line">	Elf32_Phdr *phdr = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">/* As a loader, we just care about segment,</span></span><br><span class="line"><span class="comment">         * so we just parse program headers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">	u_char *ptr_ph_table = <span class="literal">NULL</span>;</span><br><span class="line">        Elf32_Half ph_entry_count;</span><br><span class="line">        Elf32_Half ph_entry_size;</span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// check whether `binary` is a ELF file.</span></span><br><span class="line">	<span class="keyword">if</span> (size &lt; <span class="number">4</span> || !is_elf_format(binary)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ptr_ph_table = binary + ehdr-&gt;e_phoff;</span><br><span class="line">        ph_entry_count = ehdr-&gt;e_phnum;</span><br><span class="line">        ph_entry_size = ehdr-&gt;e_phentsize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (ph_entry_count--) &#123;</span><br><span class="line">                phdr = (Elf32_Phdr *)ptr_ph_table;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (phdr-&gt;p_type == PT_LOAD) &#123;</span><br><span class="line">	<span class="comment">/* Your task here!  */</span></span><br><span class="line">        <span class="comment">/* Real map all section at correct virtual address.Return &lt; 0 if error. */</span></span><br><span class="line">        <span class="comment">/* Hint: Call the callback function you have achieved before. */</span></span><br><span class="line">					r = <span class="built_in">map</span>(phdr-&gt;p_vaddr, phdr-&gt;p_memsz,  binary + phdr-&gt;p_offset, phdr-&gt;p_filesz, user_data);</span><br><span class="line">					<span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">						<span class="keyword">return</span> r;</span><br><span class="line">					&#125;	</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ptr_ph_table += ph_entry_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *entry_point = ehdr-&gt;e_entry;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="kclock-init"><a href="#kclock-init" class="headerlink" title="kclock_init"></a><code>kclock_init</code></h3><p>位置：<code>lib/kclock.c</code></p>
<p>初始化时钟，主要调用<code>set_timer</code></p>
<hr>
<h3 id="SAVE-ALL"><a href="#SAVE-ALL" class="headerlink" title="SAVE_ALL"></a><code>SAVE_ALL</code></h3><p>位置：<code>include/stackframe.h</code></p>
<hr>
<h3 id="lcontext"><a href="#lcontext" class="headerlink" title="lcontext"></a><code>lcontext</code></h3><p>汇编函数，更换地址空间，在进程切换时用到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LEAF(lcontext)</span><br><span class="line">		.extern	mCONTEXT</span><br><span class="line">		sw		a0,mCONTEXT</span><br><span class="line">		jr	ra</span><br><span class="line">		nop</span><br><span class="line">END(lcontext)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="env-pop-tf"><a href="#env-pop-tf" class="headerlink" title="env_pop_tf"></a><code>env_pop_tf</code></h3><p>位置：<code>lib/env_asm.S</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">env_pop_tf</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf, <span class="type">int</span> id)</span>;</span><br></pre></td></tr></table></figure>



<p>恢复现场，异常返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">LEAF(env_pop_tf)</span><br><span class="line">.set	mips1          </span><br><span class="line">		//1:	j	1b</span><br><span class="line">	nop    </span><br><span class="line">		move		k0,a0 </span><br><span class="line">		mtc0	a1,CP0_ENTRYHI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mfc0	t0,CP0_STATUS                    </span><br><span class="line">		ori	t0,0x3                          </span><br><span class="line">		xori	t0,0x3                          </span><br><span class="line">		mtc0	t0,CP0_STATUS                    </span><br><span class="line">				 </span><br><span class="line">		lw	v1,TF_LO(k0)                                       </span><br><span class="line">		mtlo	v1                               </span><br><span class="line">		lw	v0,TF_HI(k0)                     </span><br><span class="line">		lw	v1,TF_EPC(k0)                    </span><br><span class="line">		mthi	v0                               </span><br><span class="line">		mtc0	v1,CP0_EPC                       </span><br><span class="line">		lw	$31,TF_REG31(k0)                 </span><br><span class="line">		lw	$30,TF_REG30(k0)     </span><br><span class="line">		lw	$29,TF_REG29(k0)            </span><br><span class="line">		lw	$28,TF_REG28(k0)                 </span><br><span class="line">		lw	$25,TF_REG25(k0)                 </span><br><span class="line">		lw	$24,TF_REG24(k0)                 </span><br><span class="line">		lw	$23,TF_REG23(k0)                 </span><br><span class="line">		lw	$22,TF_REG22(k0)                 </span><br><span class="line">		lw	$21,TF_REG21(k0)                 </span><br><span class="line">		lw	$20,TF_REG20(k0)                 </span><br><span class="line">		lw	$19,TF_REG19(k0)                 </span><br><span class="line">		lw	$18,TF_REG18(k0)                 </span><br><span class="line">		lw	$17,TF_REG17(k0)                 </span><br><span class="line">		lw	$16,TF_REG16(k0)                 </span><br><span class="line">		lw	$15,TF_REG15(k0)                 </span><br><span class="line">		lw	$14,TF_REG14(k0)                 </span><br><span class="line">		lw	$13,TF_REG13(k0)                 </span><br><span class="line">		lw	$12,TF_REG12(k0)                 </span><br><span class="line">		lw	$11,TF_REG11(k0)                 </span><br><span class="line">		lw	$10,TF_REG10(k0)                 </span><br><span class="line">		lw	$9,TF_REG9(k0)                   </span><br><span class="line">		lw	$8,TF_REG8(k0)                   </span><br><span class="line">		lw	$7,TF_REG7(k0)                   </span><br><span class="line">		lw	$6,TF_REG6(k0)                   </span><br><span class="line">		lw	$5,TF_REG5(k0)                   </span><br><span class="line">		lw	$4,TF_REG4(k0)                   </span><br><span class="line">		lw	$3,TF_REG3(k0)                   </span><br><span class="line">		lw	$2,TF_REG2(k0)                   </span><br><span class="line">		lw	$1,TF_REG1(k0)</span><br><span class="line"></span><br><span class="line">		lw	k1,TF_PC(k0)</span><br><span class="line"></span><br><span class="line">		lw	k0,TF_STATUS(k0)                 </span><br><span class="line">		nop					 </span><br><span class="line">		mtc0	k0,CP0_STATUS</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">		j	k1</span><br><span class="line">		rfe # 这里也可以看到进程被调度运行之前一定会执行rfe指令</span><br><span class="line">		nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">END(env_pop_tf)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="GET-ENV-ASID"><a href="#GET-ENV-ASID" class="headerlink" title="GET_ENV_ASID"></a><code>GET_ENV_ASID</code></h3><p>对给定的<code>envid</code>，解析<code>ASID</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GET_ENV_ASID(envid) (((envid)&gt;&gt; 11)&lt;&lt;6)</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="env-run"><a href="#env-run" class="headerlink" title="env_run"></a><code>env_run</code></h3><p>位置：<code>lib/env.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_run</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Step 1: save register state of curenv. */</span></span><br><span class="line">    <span class="comment">/* Hint: if there is an environment running, </span></span><br><span class="line"><span class="comment">     *   you should switch the context and save the registers. </span></span><br><span class="line"><span class="comment">     *   You can imitate env_destroy() &#x27;s behaviors.*/</span></span><br><span class="line">	<span class="keyword">if</span> (curenv) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> *<span class="title">old</span> =</span> (<span class="keyword">struct</span> Trapframe *)(TIMESTACK - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Trapframe));</span><br><span class="line">		bcopy(old, &amp;(curenv-&gt;env_tf), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Trapframe));</span><br><span class="line">		curenv-&gt;env_tf.pc = curenv-&gt;env_tf.cp0_epc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 2: Set &#x27;curenv&#x27; to the new environment. */</span></span><br><span class="line">	curenv = e;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 3: Use lcontext() to switch to its address space. */</span></span><br><span class="line">	lcontext(curenv-&gt;env_pgdir);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step 4: Use env_pop_tf() to restore the environment&#x27;s</span></span><br><span class="line"><span class="comment">     *   environment   registers and return to user mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Hint: You should use GET_ENV_ASID there. Think why?</span></span><br><span class="line"><span class="comment">     *   (read &lt;see mips run linux&gt;, page 135-144)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	env_pop_tf(&amp;(curenv-&gt;env_tf), GET_ENV_ASID(curenv-&gt;env_id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="env-destroy"><a href="#env-destroy" class="headerlink" title="env_destroy"></a><code>env_destroy</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_destroy</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Hint: free e. */</span></span><br><span class="line">    env_free(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Hint: schedule to run a new environment. */</span></span><br><span class="line">    <span class="keyword">if</span> (curenv == e) &#123;</span><br><span class="line">        curenv = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">/* Hint: Why this? */</span></span><br><span class="line">        bcopy((<span class="type">void</span> *)KERNEL_SP - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Trapframe),</span><br><span class="line">              (<span class="type">void</span> *)TIMESTACK - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Trapframe),</span><br><span class="line">              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Trapframe));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i am killed ... \n&quot;</span>);</span><br><span class="line">        sched_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="set-except-vector"><a href="#set-except-vector" class="headerlink" title="set_except_vector"></a><code>set_except_vector</code></h3><p>返回值：<code>void *</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">set_except_vector</span><span class="params">(<span class="type">int</span> n, <span class="type">void</span> *addr)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> handler = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> old_handler = exception_handlers[n];</span><br><span class="line">    exception_handlers[n] = handler;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span> *) old_handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置异常向量组偏移为<code>n</code>的内容为<code>addr</code>指向的函数；若偏移量为<code>n</code>的地方原来有数，则将其以<code>void *</code>形式返回。</p>
<p>这里我们可以将代码和寄存器结构对应上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set_except_vector(<span class="number">0</span>, handle_int);</span><br><span class="line">set_except_vector(<span class="number">1</span>, handle_mod);</span><br><span class="line">set_except_vector(<span class="number">2</span>, handle_tlb);</span><br><span class="line">set_except_vector(<span class="number">3</span>, handle_tlb);</span><br><span class="line">set_except_vector(<span class="number">8</span>, handle_sys);</span><br></pre></td></tr></table></figure>

<p><img src="/2022-04-26-%E3%80%8CBUAA-OS-Lab3%E3%80%8D%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A.assets/image-20220509184223967.png" alt="image-20220509184223967"></p>
<p><img src="/2022-04-26-%E3%80%8CBUAA-OS-Lab3%E3%80%8D%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A.assets/image-20220509184233622.png" alt="image-20220509184233622"></p>
<p>由此进一步软硬件互相印证。</p>
<hr>
<h3 id="handle-int"><a href="#handle-int" class="headerlink" title="handle_int"></a><code>handle_int</code></h3><p>0号异常的处理函数，表示中断，由时钟中断、控制台中断等中断造成。</p>
<p>位置：<code>lib/genex.S</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NESTED(handle_int, TF_SIZE, sp)</span><br><span class="line">//.set	noat</span><br><span class="line"></span><br><span class="line">//1: j 1b</span><br><span class="line">nop</span><br><span class="line"></span><br><span class="line">SAVE_ALL</span><br><span class="line">CLI</span><br><span class="line">.set	at</span><br><span class="line">mfc0	t0, CP0_CAUSE</span><br><span class="line">mfc0	t2, CP0_STATUS</span><br><span class="line">and	t0, t2</span><br><span class="line"></span><br><span class="line">andi	t1, t0, STATUSF_IP4</span><br><span class="line">bnez	t1, timer_irq</span><br><span class="line">nop</span><br><span class="line">END(handle_int)</span><br></pre></td></tr></table></figure>

<h3 id="handle-mod"><a href="#handle-mod" class="headerlink" title="handle_mod"></a><code>handle_mod</code></h3><p>1号异常的处理函数</p>
<p>位置：<code>lib/genex.S</code>和<code>lib/traps.c</code></p>
<p>通过<code>genex.S</code>中的汇编宏函数和<code>traps.c</code>中的代码实现来组合完成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.macro	BUILD_HANDLER exception handler clear</span><br><span class="line">	.align	5</span><br><span class="line">	NESTED(handle_\exception, TF_SIZE, sp)  </span><br><span class="line">	//.set	noat</span><br><span class="line"></span><br><span class="line">nop</span><br><span class="line"></span><br><span class="line">	SAVE_ALL				</span><br><span class="line">	__build_clear_\clear</span><br><span class="line">	.set	at</span><br><span class="line">	move	a0, sp</span><br><span class="line">	jal	\handler</span><br><span class="line">	nop</span><br><span class="line">	j	ret_from_exception</span><br><span class="line">	nop</span><br><span class="line">	END(handle_\exception)</span><br><span class="line">.endm</span><br><span class="line">BUILD_HANDLER mod	page_fault_handler cli</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void page_fault_handler(struct Trapframe *tf)</span><br><span class="line">&#123;</span><br><span class="line">    struct Trapframe PgTrapFrame;</span><br><span class="line">    extern struct Env *curenv;</span><br><span class="line"></span><br><span class="line">    bcopy(tf, &amp;PgTrapFrame, sizeof(struct Trapframe));</span><br><span class="line"></span><br><span class="line">    if (tf-&gt;regs[29] &gt;= (curenv-&gt;env_xstacktop - BY2PG) &amp;&amp;</span><br><span class="line">        tf-&gt;regs[29] &lt;= (curenv-&gt;env_xstacktop - 1))</span><br><span class="line">    &#123;</span><br><span class="line">        tf-&gt;regs[29] = tf-&gt;regs[29] - sizeof(struct Trapframe);</span><br><span class="line">        bcopy(&amp;PgTrapFrame, (void *)tf-&gt;regs[29], sizeof(struct Trapframe));</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        tf-&gt;regs[29] = curenv-&gt;env_xstacktop - sizeof(struct Trapframe);</span><br><span class="line">        bcopy(&amp;PgTrapFrame, (void *)curenv-&gt;env_xstacktop - sizeof(struct Trapframe), sizeof(struct Trapframe));</span><br><span class="line">    &#125;</span><br><span class="line">    // TODO: Set EPC to a proper value in the trapframe</span><br><span class="line">    tf-&gt;cp0_epc = curenv-&gt;env_pgfault_handler;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="handle-tlb"><a href="#handle-tlb" class="headerlink" title="handle_tlb"></a><code>handle_tlb</code></h3><p>位置：<code>lib/genex.S</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.macro	BUILD_HANDLER exception handler clear</span><br><span class="line">	.align	5</span><br><span class="line">	NESTED(handle_\exception, TF_SIZE, sp)  </span><br><span class="line">	//.set	noat</span><br><span class="line"></span><br><span class="line">nop</span><br><span class="line"></span><br><span class="line">	SAVE_ALL				</span><br><span class="line">	__build_clear_\clear</span><br><span class="line">	.set	at</span><br><span class="line">	move	a0, sp</span><br><span class="line">	jal	\handler</span><br><span class="line">	nop</span><br><span class="line">	j	ret_from_exception</span><br><span class="line">	nop</span><br><span class="line">	END(handle_\exception)</span><br><span class="line">.endm</span><br><span class="line">BUILD_HANDLER tlb	do_refill	cli</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">NESTED(do_refill,0 , sp)</span><br><span class="line">			//li	k1, &#x27;?&#x27;</span><br><span class="line">			//sb	k1, 0x90000000</span><br><span class="line">			.extern	mCONTEXT</span><br><span class="line">//this &quot;1&quot; is important</span><br><span class="line">1:			//j 1b</span><br><span class="line">			nop</span><br><span class="line">			lw		k1,mCONTEXT</span><br><span class="line">			and		k1,0xfffff000</span><br><span class="line">				mfc0		k0,CP0_BADVADDR</span><br><span class="line">				srl		k0,20</span><br><span class="line">				and		k0,0xfffffffc</span><br><span class="line">			addu		k0,k1</span><br><span class="line">			</span><br><span class="line">			lw		k1,0(k0)</span><br><span class="line">			nop</span><br><span class="line">					move		t0,k1</span><br><span class="line">					and		t0,0x0200</span><br><span class="line">					beqz		t0,NOPAGE</span><br><span class="line">			nop</span><br><span class="line">			and		k1,0xfffff000</span><br><span class="line">				mfc0		k0,CP0_BADVADDR</span><br><span class="line">				srl		k0,10</span><br><span class="line">				and		k0,0xfffffffc</span><br><span class="line">				and		k0,0x00000fff</span><br><span class="line">			addu		k0,k1</span><br><span class="line"></span><br><span class="line">			or		k0,0x80000000</span><br><span class="line">			lw		k1,0(k0)</span><br><span class="line">			nop</span><br><span class="line">					move		t0,k1</span><br><span class="line">					and		t0,0x0200</span><br><span class="line">					beqz		t0,NOPAGE</span><br><span class="line">			nop</span><br><span class="line">			move		k0,k1</span><br><span class="line">			and		k0,0x1</span><br><span class="line">			beqz		k0,NoCOW</span><br><span class="line">			nop</span><br><span class="line">			and		k1,0xfffffbff</span><br><span class="line">NoCOW:</span><br><span class="line">			mtc0		k1,CP0_ENTRYLO0</span><br><span class="line">			nop</span><br><span class="line">			tlbwr</span><br><span class="line"></span><br><span class="line">			j		2f</span><br><span class="line">			nop</span><br><span class="line">NOPAGE:</span><br><span class="line">//3: j 3b</span><br><span class="line">nop</span><br><span class="line">			mfc0		a0,CP0_BADVADDR</span><br><span class="line">			lw		a1,mCONTEXT</span><br><span class="line">			nop</span><br><span class="line">				</span><br><span class="line">			sw	 	ra,tlbra</span><br><span class="line">			jal		pageout</span><br><span class="line">			nop</span><br><span class="line">//3: j 3b</span><br><span class="line">nop</span><br><span class="line">			lw		ra,tlbra</span><br><span class="line">			nop</span><br><span class="line"></span><br><span class="line">			j	1b</span><br><span class="line">2:			nop</span><br><span class="line"></span><br><span class="line">			jr		ra</span><br><span class="line">			nop</span><br><span class="line">END(do_refill)</span><br></pre></td></tr></table></figure>

<h3 id="handle-sys"><a href="#handle-sys" class="headerlink" title="handle_sys"></a><code>handle_sys</code></h3><p>位置：<code>lib/syscall.S</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">NESTED(handle_sys,TF_SIZE, sp)</span><br><span class="line">    SAVE_ALL                            // Macro used to save trapframe</span><br><span class="line">    CLI                                 // Clean Interrupt Mask</span><br><span class="line">    nop</span><br><span class="line">    .set at                             // Resume use of $at</span><br><span class="line"></span><br><span class="line">    // TODO: Fetch EPC from Trapframe, calculate a proper value and store it back to trapframe.</span><br><span class="line">	</span><br><span class="line">	lw		t0, TF_EPC(sp)</span><br><span class="line">	addiu	t0, t0, 4</span><br><span class="line">	sw		t0, TF_EPC(sp)</span><br><span class="line">    // TODO: Copy the syscall number into $a0.</span><br><span class="line">    </span><br><span class="line">	lw		a0, TF_REG4(sp)</span><br><span class="line"></span><br><span class="line">    addiu   a0, a0, -__SYSCALL_BASE     // a0 &lt;- relative syscall number</span><br><span class="line">    sll     t0, a0, 2                   // t0 &lt;- relative syscall number times 4</span><br><span class="line">    la      t1, sys_call_table          // t1 &lt;- syscall table base</span><br><span class="line">    addu    t1, t1, t0                  // t1 &lt;- table entry of specific syscall</span><br><span class="line">    lw      t2, 0(t1)                   // t2 &lt;- function entry of specific syscall</span><br><span class="line"></span><br><span class="line">    lw      t0, TF_REG29(sp)            // t0 &lt;- user stack pointer</span><br><span class="line">    lw      t3, 16(t0)                  // t3 &lt;- the 5th argument of msyscall</span><br><span class="line">    lw      t4, 20(t0)                  // t4 &lt;- the 6th argument of msyscall</span><br><span class="line"></span><br><span class="line">    // TODO: Allocate a space of six arguments on current kernel stack and copy the six arguments to proper location</span><br><span class="line">    lw		a0, TF_REG4(sp)</span><br><span class="line">	lw		a1, TF_REG5(sp)</span><br><span class="line">	lw		a2, TF_REG6(sp)</span><br><span class="line">	lw		a3, TF_REG7(sp)</span><br><span class="line">	addiu	sp, sp, -24</span><br><span class="line">	sw		a0, 0(sp)</span><br><span class="line">	sw		a1, 4(sp)</span><br><span class="line">	sw		a2, 8(sp)</span><br><span class="line">	sw		a3, 12(sp)</span><br><span class="line">	sw		t3, 16(sp)</span><br><span class="line">	sw		t4, 20(sp)</span><br><span class="line">    </span><br><span class="line">    jalr    t2                          // Invoke sys_* function</span><br><span class="line">    nop</span><br><span class="line">    </span><br><span class="line">    // TODO: Resume current kernel stack</span><br><span class="line">    addiu	sp, sp, 24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sw      v0, TF_REG2(sp)             // Store return value of function sys_* (in $v0) into trapframe</span><br><span class="line"></span><br><span class="line">    j       ret_from_exception          // Return from exeception</span><br><span class="line">    nop</span><br><span class="line">END(handle_sys)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="kclock-init-1"><a href="#kclock-init-1" class="headerlink" title="kclock_init"></a><code>kclock_init</code></h3><p>位置：<code>lib/kclock.c</code></p>
<p>kernel clock init，时钟初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kclock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	set_timer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="set-timer"><a href="#set-timer" class="headerlink" title="set_timer"></a><code>set_timer</code></h3><p>位置：<code>kclock_asm.S</code></p>
<p>设置时钟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LEAF(set_timer)</span><br><span class="line"></span><br><span class="line">	li t0, 0xc8</span><br><span class="line">	sb t0, 0xb5000100</span><br><span class="line">	sw	sp, KERNEL_SP</span><br><span class="line">setup_c0_status STATUS_CU0|0x1001 0</span><br><span class="line">	jr ra</span><br><span class="line"></span><br><span class="line">	nop</span><br><span class="line">END(set_timer)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="timer-irq"><a href="#timer-irq" class="headerlink" title="timer_irq"></a><code>timer_irq</code></h3><p>timer InterRupt Request，时钟中断请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">timer_irq:</span><br><span class="line"></span><br><span class="line">1:	j	sched_yield</span><br><span class="line">	nop</span><br><span class="line">	/*li t1, 0xff</span><br><span class="line">	lw    t0, delay</span><br><span class="line">	addu  t0, 1</span><br><span class="line">	sw	t0, delay</span><br><span class="line">	beq	t0,t1,1f	</span><br><span class="line">	nop*/</span><br><span class="line">	j	ret_from_exception</span><br><span class="line">	nop</span><br></pre></td></tr></table></figure>

<p>跳转到<code>sched_yield</code></p>
<hr>
<h3 id="sched-yield"><a href="#sched-yield" class="headerlink" title="sched_yield"></a><code>sched_yield</code></h3><p>位置：<code>lib/sched.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">sched_yield</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> count = <span class="number">0</span>; <span class="comment">// remaining time slices of current env</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> point = <span class="number">0</span>; <span class="comment">// current env_sched_list index</span></span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//printf(&quot;\ncurenv-&gt;env_id : %d\n&quot;, e-&gt;env_id);</span></span><br><span class="line">    <span class="comment">/*  hint:</span></span><br><span class="line"><span class="comment">     *  1. if (count==0), insert `e` into `env_sched_list[1-point]`</span></span><br><span class="line"><span class="comment">     *     using LIST_REMOVE and LIST_INSERT_TAIL.</span></span><br><span class="line"><span class="comment">     *  2. if (env_sched_list[point] is empty), point = 1 - point;</span></span><br><span class="line"><span class="comment">     *     then search through `env_sched_list[point]` for a runnable env `e`, </span></span><br><span class="line"><span class="comment">     *     and set count = e-&gt;env_pri</span></span><br><span class="line"><span class="comment">     *  3. count--</span></span><br><span class="line"><span class="comment">     *  4. env_run()</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  functions or macros below may be used (not all):</span></span><br><span class="line"><span class="comment">     *  LIST_INSERT_TAIL, LIST_REMOVE, LIST_FIRST, LIST_EMPTY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">if</span> (count == <span class="number">0</span> || e == <span class="literal">NULL</span> || e-&gt;env_status != ENV_RUNNABLE) &#123;</span><br><span class="line">         <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">             LIST_REMOVE(e, env_sched_link);</span><br><span class="line">             <span class="keyword">if</span> (e-&gt;env_status != ENV_FREE) &#123;</span><br><span class="line">                 LIST_INSERT_TAIL(&amp;env_sched_list[<span class="number">1</span> - point], e, env_sched_link);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">             <span class="keyword">while</span>(LIST_EMPTY(&amp;env_sched_list[point])) &#123;</span><br><span class="line">                 point = <span class="number">1</span> - point;</span><br><span class="line">             &#125;</span><br><span class="line">             e = LIST_FIRST(&amp;env_sched_list[point]);</span><br><span class="line">             <span class="keyword">if</span> (e-&gt;env_status == ENV_FREE) &#123;</span><br><span class="line">                 LIST_REMOVE(e, env_sched_link);</span><br><span class="line">             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e-&gt;env_status == ENV_NOT_RUNNABLE) &#123;</span><br><span class="line">                 LIST_REMOVE(e, env_sched_link);</span><br><span class="line">                 LIST_INSERT_TAIL(&amp;env_sched_list[<span class="number">1</span> - point], e, env_sched_link);</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 count = e-&gt;env_pri;</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     count--;</span><br><span class="line">     e-&gt;env_runs++;</span><br><span class="line">	<span class="comment">// printf(&quot;\n%d\n&quot;,e-&gt;env_id);</span></span><br><span class="line">     env_run(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="SAVE-ALL-1"><a href="#SAVE-ALL-1" class="headerlink" title="SAVE_ALL"></a><code>SAVE_ALL</code></h3><p>位置：<code>include/stackframe.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">.macro SAVE_ALL    </span><br><span class="line">		<span class="comment">/* 保存SR寄存器 */</span>                          </span><br><span class="line">		mfc0	k0,CP0_STATUS     </span><br><span class="line">		<span class="comment">/* sll 逻辑左移3位，使得CU0在最高位（符号位） */</span></span><br><span class="line">		sll		k0,<span class="number">3</span>      <span class="comment">/* extract cu0 bit */</span></span><br><span class="line">		<span class="comment">/* 判断如果CU0为1跳转到1处 */</span></span><br><span class="line">		<span class="comment">/* 1f即标签1，可以参考https://blog.csdn.net/lamdoc/article/details/8979243*/</span></span><br><span class="line">		bltz	k0,<span class="number">1f</span>                            </span><br><span class="line">		nop       </span><br><span class="line">		<span class="comment">/*                                       </span></span><br><span class="line"><span class="comment">		 * Called from user mode, new stack      </span></span><br><span class="line"><span class="comment">		 */</span>                                      </span><br><span class="line">		<span class="comment">//lui	k1,%hi(kernelsp)                 </span></span><br><span class="line">		<span class="comment">//lw	k1,%lo(kernelsp)(k1)  //not clear right now </span></span><br><span class="line">		           </span><br><span class="line"><span class="number">1</span>:		<span class="comment">/* 保存sp到k0 */</span>		</span><br><span class="line">		move	k0,sp</span><br><span class="line">		<span class="comment">/* 调用宏get_sp */</span></span><br><span class="line">		get_sp      </span><br><span class="line">		move	k1,sp                     </span><br><span class="line">		subu	sp,k1,TF_SIZE                    </span><br><span class="line">		sw	k0,TF_REG29(sp)                  </span><br><span class="line">		sw	$<span class="number">2</span>,TF_REG2(sp)                   </span><br><span class="line">		mfc0	v0,CP0_STATUS                    </span><br><span class="line">		sw	v0,TF_STATUS(sp)                 </span><br><span class="line">		mfc0	v0,CP0_CAUSE                     </span><br><span class="line">		sw	v0,TF_CAUSE(sp)                  </span><br><span class="line">		mfc0	v0,CP0_EPC                       </span><br><span class="line">		sw	v0,TF_EPC(sp)</span><br><span class="line">		mfc0	v0, CP0_BADVADDR        </span><br><span class="line">		sw	v0, TF_BADVADDR(sp)            </span><br><span class="line">		mfhi	v0                               </span><br><span class="line">		sw	v0,TF_HI(sp)                     </span><br><span class="line">		mflo	v0                               </span><br><span class="line">		sw	v0,TF_LO(sp)                     </span><br><span class="line">		sw	$<span class="number">0</span>,TF_REG0(sp)</span><br><span class="line">		sw	$<span class="number">1</span>,TF_REG1(sp)                    </span><br><span class="line">		<span class="comment">//sw	$2,TF_REG2(sp)                   </span></span><br><span class="line">		sw	$<span class="number">3</span>,TF_REG3(sp)                   </span><br><span class="line">		sw	$<span class="number">4</span>,TF_REG4(sp)                   </span><br><span class="line">		sw	$<span class="number">5</span>,TF_REG5(sp)                   </span><br><span class="line">		sw	$<span class="number">6</span>,TF_REG6(sp)                   </span><br><span class="line">		sw	$<span class="number">7</span>,TF_REG7(sp)                   </span><br><span class="line">		sw	$<span class="number">8</span>,TF_REG8(sp)                   </span><br><span class="line">		sw	$<span class="number">9</span>,TF_REG9(sp)                   </span><br><span class="line">		sw	$<span class="number">10</span>,TF_REG10(sp)                 </span><br><span class="line">		sw	$<span class="number">11</span>,TF_REG11(sp)                 </span><br><span class="line">		sw	$<span class="number">12</span>,TF_REG12(sp)                 </span><br><span class="line">		sw	$<span class="number">13</span>,TF_REG13(sp)                 </span><br><span class="line">		sw	$<span class="number">14</span>,TF_REG14(sp)                 </span><br><span class="line">		sw	$<span class="number">15</span>,TF_REG15(sp)                 </span><br><span class="line">		sw	$<span class="number">16</span>,TF_REG16(sp)                 </span><br><span class="line">		sw	$<span class="number">17</span>,TF_REG17(sp)                 </span><br><span class="line">		sw	$<span class="number">18</span>,TF_REG18(sp)                 </span><br><span class="line">		sw	$<span class="number">19</span>,TF_REG19(sp)                 </span><br><span class="line">		sw	$<span class="number">20</span>,TF_REG20(sp)                 </span><br><span class="line">		sw	$<span class="number">21</span>,TF_REG21(sp)                 </span><br><span class="line">		sw	$<span class="number">22</span>,TF_REG22(sp)                 </span><br><span class="line">		sw	$<span class="number">23</span>,TF_REG23(sp)                 </span><br><span class="line">		sw	$<span class="number">24</span>,TF_REG24(sp)                 </span><br><span class="line">		sw	$<span class="number">25</span>,TF_REG25(sp)                 </span><br><span class="line">		sw	$<span class="number">26</span>,TF_REG26(sp) 				 </span><br><span class="line">		sw	$<span class="number">27</span>,TF_REG27(sp) 				 </span><br><span class="line">		sw	$<span class="number">28</span>,TF_REG28(sp)                 </span><br><span class="line">		sw	$<span class="number">30</span>,TF_REG30(sp)                 </span><br><span class="line">		sw	$<span class="number">31</span>,TF_REG31(sp)</span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="get-sp"><a href="#get-sp" class="headerlink" title="get_sp"></a><code>get_sp</code></h3><p>位置：<code>include/stackframe.h</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.macro get_sp</span><br><span class="line">	mfc0	k1, CP0_CAUSE</span><br><span class="line">	andi	k1, 0x107C</span><br><span class="line">	xori	k1, 0x1000</span><br><span class="line">	bnez	k1, 1f</span><br><span class="line">	nop</span><br><span class="line">	li	sp, 0x82000000</span><br><span class="line">	j	2f</span><br><span class="line">	nop</span><br><span class="line">1:</span><br><span class="line">	bltz	sp, 2f</span><br><span class="line">	nop</span><br><span class="line">	lw	sp, KERNEL_SP</span><br><span class="line">	nop</span><br><span class="line"></span><br><span class="line">2:	nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>


                
                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2022/04/29/「BUAA-OS-Lab3-1-Extra」模拟PV操作/" data-toggle="tooltip" data-placement="top" title="「BUAA OS Lab3-1-Extra」模拟PV操作">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2022/04/20/「BUAA-Discrete-Mathematics-Chapter6」容斥原理及应用/" data-toggle="tooltip" data-placement="top" title="「BUAA Discrete Mathematics Chapter6」容斥原理及应用">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- tip start -->
                

                
                <div class="comment_notes">
                    <p>
                        This is copyright.
                    </p>
                </div>
                
                <!-- tip end -->

                <!-- Music start-->
                
                <!-- Music end -->

                <!-- Sharing -->
                
                <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                <!--  css & js -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!-- Sharing -->

                <!-- gitment start -->
                
                <hr>
                <div id="blog_comments"></div>

<!--
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
-->
<!--
<link rel="stylesheet" href="/css/gitment.css">
<script type="text/javascript" src="/js/gitment.js"></script>
-->

<script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css"/>

<!--
<link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
<script src="https://billts.site/js/gitment.js"></script>
-->

<script>
const myTheme = {
  render(state, instance) {
    const container = document.createElement('div')
    container.lang = "en-US"
    container.className = 'gitment-container gitment-root-container'
    
     // your custom component
    container.appendChild(instance.renderSomething(state, instance))
    
    container.appendChild(instance.renderHeader(state, instance))
    container.appendChild(instance.renderComments(state, instance))
    container.appendChild(instance.renderEditor(state, instance))
    //container.appendChild(instance.renderFooter(state, instance))
    return container
  },
  renderSomething(state, instance) {
    const container = document.createElement('div')
    container.lang = "en-US"
    container.className = 'hello_visitor'
    if (state.user.login) {
      container.innerText = `Hello ${state.user.login}, Welcome to comment system`
    }
    return container
  }
}


const gitment = new Gitment({
    id: 'Tue Apr 26 2022 22:42:52 GMT+0800', // optional
    owner: "saltyfishyjk",
    repo: "saltyfishyjk.github.io",
    oauth: {
      client_id: "17737ec06ef80355865e",
      client_secret: "d79eba1e32e61803f07e93646964a7978e09f515",
    },
    theme: myTheme,
    // ...
    // For more available options, check out the documentation below
  })
  
  gitment.render('blog_comments')
  // or
  // gitment.render(document.getElementById('comments'))
  // or
  // document.body.appendChild(gitment.render())
</script>
                
                <!-- gitment end -->

                <!-- 来必力City版安装代码 -->
                
                <!-- City版安装代码已完成 -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      
        <aside id="sidebar">
          <div id="toc" class="toc-article">
          <strong class="toc-title">Contents</strong>
          
            
              <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E3%80%8CBUAA-OS-Lab3%E3%80%8D%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">「BUAA OS Lab3」名词解释</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%98%E9%87%8F%E5%92%8C%E7%B1%BB%E5%9E%8B"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">变量和类型</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#PCB"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">PCB</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Env"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">Env</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Env-list"><span class="toc-nav-number">1.1.3.</span> <span class="toc-nav-text">Env_list</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-tf"><span class="toc-nav-number">1.1.4.</span> <span class="toc-nav-text">env_tf</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Trapframe"><span class="toc-nav-number">1.1.5.</span> <span class="toc-nav-text">Trapframe</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-link"><span class="toc-nav-number">1.1.6.</span> <span class="toc-nav-text">env_link</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-id"><span class="toc-nav-number">1.1.7.</span> <span class="toc-nav-text">env_id</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-parent-id"><span class="toc-nav-number">1.1.8.</span> <span class="toc-nav-text">env_parent_id</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-status"><span class="toc-nav-number">1.1.9.</span> <span class="toc-nav-text">env_status</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-pgdir"><span class="toc-nav-number">1.1.10.</span> <span class="toc-nav-text">env_pgdir</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-cr3"><span class="toc-nav-number">1.1.11.</span> <span class="toc-nav-text">env_cr3</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-sched-link"><span class="toc-nav-number">1.1.12.</span> <span class="toc-nav-text">env_sched_link</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-pri"><span class="toc-nav-number">1.1.13.</span> <span class="toc-nav-text">env_pri</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-runs"><span class="toc-nav-number">1.1.14.</span> <span class="toc-nav-text">env_runs</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#LOG2NENV"><span class="toc-nav-number">1.1.15.</span> <span class="toc-nav-text">LOG2NENV</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#UTOP%E4%B8%8EULIM"><span class="toc-nav-number">1.1.16.</span> <span class="toc-nav-text">UTOP与ULIM</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#cp0-status"><span class="toc-nav-number">1.1.17.</span> <span class="toc-nav-text">cp0_status</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#KUo-IEo-KUp-IEp-KUc-IEc-rfe"><span class="toc-nav-number">1.1.18.</span> <span class="toc-nav-text">KUo &amp; IEo &#x2F;&#x2F; KUp &amp; IEp &#x2F;&#x2F; KUc &amp; IEc || rfe</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#TIMESTACK"><span class="toc-nav-number">1.1.19.</span> <span class="toc-nav-text">TIMESTACK</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#exception-handlers"><span class="toc-nav-number">1.1.20.</span> <span class="toc-nav-text">exception_handlers</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%87%BD%E6%95%B0%E5%92%8C%E5%AE%8F%E5%87%BD%E6%95%B0"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">函数和宏函数</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-init"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">env_init()</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#mkenvid"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">mkenvid</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#asid-alloc"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">asid_alloc()</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#envid2env"><span class="toc-nav-number">1.2.4.</span> <span class="toc-nav-text">envid2env</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-alloc"><span class="toc-nav-number">1.2.5.</span> <span class="toc-nav-text">env_alloc</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-setup-vm"><span class="toc-nav-number">1.2.6.</span> <span class="toc-nav-text">env_setup_vm</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-create"><span class="toc-nav-number">1.2.7.</span> <span class="toc-nav-text">env_create</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-create-priority"><span class="toc-nav-number">1.2.8.</span> <span class="toc-nav-text">env_create_priority</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ENV-CREATE"><span class="toc-nav-number">1.2.9.</span> <span class="toc-nav-text">ENV_CREATE</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ENV-CREATE-PRIORITY"><span class="toc-nav-number">1.2.10.</span> <span class="toc-nav-text">ENV_CREATE_PRIORITY</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#load-icode"><span class="toc-nav-number">1.2.11.</span> <span class="toc-nav-text">load_icode</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#load-icode-mapper"><span class="toc-nav-number">1.2.12.</span> <span class="toc-nav-text">load_icode_mapper</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#is-elf-format"><span class="toc-nav-number">1.2.13.</span> <span class="toc-nav-text">is_elf_format</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#load-elf"><span class="toc-nav-number">1.2.14.</span> <span class="toc-nav-text">load_elf</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#kclock-init"><span class="toc-nav-number">1.2.15.</span> <span class="toc-nav-text">kclock_init</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#SAVE-ALL"><span class="toc-nav-number">1.2.16.</span> <span class="toc-nav-text">SAVE_ALL</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#lcontext"><span class="toc-nav-number">1.2.17.</span> <span class="toc-nav-text">lcontext</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-pop-tf"><span class="toc-nav-number">1.2.18.</span> <span class="toc-nav-text">env_pop_tf</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#GET-ENV-ASID"><span class="toc-nav-number">1.2.19.</span> <span class="toc-nav-text">GET_ENV_ASID</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-run"><span class="toc-nav-number">1.2.20.</span> <span class="toc-nav-text">env_run</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#env-destroy"><span class="toc-nav-number">1.2.21.</span> <span class="toc-nav-text">env_destroy</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#set-except-vector"><span class="toc-nav-number">1.2.22.</span> <span class="toc-nav-text">set_except_vector</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#handle-int"><span class="toc-nav-number">1.2.23.</span> <span class="toc-nav-text">handle_int</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#handle-mod"><span class="toc-nav-number">1.2.24.</span> <span class="toc-nav-text">handle_mod</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#handle-tlb"><span class="toc-nav-number">1.2.25.</span> <span class="toc-nav-text">handle_tlb</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#handle-sys"><span class="toc-nav-number">1.2.26.</span> <span class="toc-nav-text">handle_sys</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#kclock-init-1"><span class="toc-nav-number">1.2.27.</span> <span class="toc-nav-text">kclock_init</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#set-timer"><span class="toc-nav-number">1.2.28.</span> <span class="toc-nav-text">set_timer</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#timer-irq"><span class="toc-nav-number">1.2.29.</span> <span class="toc-nav-text">timer_irq</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#sched-yield"><span class="toc-nav-number">1.2.30.</span> <span class="toc-nav-text">sched_yield</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#SAVE-ALL-1"><span class="toc-nav-number">1.2.31.</span> <span class="toc-nav-text">SAVE_ALL</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#get-sp"><span class="toc-nav-number">1.2.32.</span> <span class="toc-nav-text">get_sp</span></a></li></ol></li></ol></li></ol>
            
          
          </div>
        </aside>
      
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#BUAA-OS" title="BUAA-OS">BUAA-OS</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://thysrael.github.io/" target="_blank">Thysrael</a></li>
                    
                        <li><a href="https://wxx0105.cn/" target="_blank">贤弟安全</a></li>
                    
                        <li><a href="https://iszry.github.io" target="_blank">Matcha Flavor</a></li>
                    
                        <li><a href="https://master-tan.github.io/" target="_blank">Tan&#39;s Blog</a></li>
                    
                        <li><a href="https://mksasx.github.io/" target="_blank">AustinMa</a></li>
                    
                        <li><a href="https://bluebean-cloud.github.io/" target="_blank">Bluebean</a></li>
                    
                        <li><a href="https://chlience.cn/" target="_blank">Chlience</a></li>
                    
                        <li><a href="https://sunnyduan-oss.github.io/" target="_blank">甜胖妮</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>


<style  type="text/css">
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                
                    <li>
                        <a target="_blank"  href="https://github.com/saltyfishyjk">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/gu-long-mo-yu">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; saltyfishyjk 2025 
                    <br>
                    Powered by 
                    <a href="https://github.com/saltyfishyjk/saltyfishyjk.github.io">
                        <i>saltyfishyjk</i>
                    </a> | 
                    <iframe name="star" style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0"
                        width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=saltyfishyjk&repo=saltyfishyjk.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>

</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>


<!-- Search -->

<script src="/js/search.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://saltyfishyjk.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Search -->

    <script type="text/javascript">      
        var search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
    var path = "/" + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>


<!-- busuanzi -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>

    
        <!-- background effects line -->
        

        
            <script type="text/javascript" src="/js/mouse-click.js" content='[&#34;🐟&#34;]' color='[&#34;rgb(121,93,179)&#34; ,&#34;rgb(76,180,231)&#34;]'></script>
        

        <!-- background effects end -->
    

    <!--<script size="50" alpha='0.3' zIndex="-999" src="/js/ribbonStatic.js"></script>-->
    
        <script src="/js/ribbonDynamic.js"></script>
    
</body>

</html>
